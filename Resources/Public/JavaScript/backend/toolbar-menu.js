import e from"@typo3/core/document-service.js";import t from"@typo3/core/event/regular-event.js";import{_ as r,t as n,C as o,L as i,I as a}from"../cache-warmer.js";import{LitElement as s}from"lit";import l from"@typo3/backend/icons.js";import c from"@typo3/backend/modal.js";import u from"@typo3/backend/notification.js";import"@typo3/backend/action-button/immediate-action.js";import"@typo3/core/ajax/ajax-request.js";const d=(e,t,r)=>(r.configurable=!0,r.enumerable=!0,Reflect.decorate&&"object"!=typeof t&&Object.defineProperty(e,t,r),r);function p(e,t){return(t,r,n)=>d(t,r,{get(){return(t=>t.renderRoot?.querySelector(e)??null)(this)}})}let g;function h(e){return(t,r)=>d(t,r,{get(){return(this.renderRoot??(g??=document.createDocumentFragment())).querySelectorAll(e)}})}var m="text/plain",f=e=>{};function b(e){f(e)}var y=!0;(function(){(console.warn||console.log).apply(console,arguments)}).bind("[clipboard-polyfill]");var v,w,x,C="undefined"==typeof window?void 0:window,T="undefined"==typeof globalThis?void 0:globalThis,k=null!=(x=null==(v=C)?void 0:v.Promise)?x:null==(w=T)?void 0:w.Promise;var S,_,E,I,A,D="undefined"==typeof navigator?void 0:navigator,G=null==D?void 0:D.clipboard,j=null==(S=null==G?void 0:G.read)?void 0:S.bind(G),L=null==(_=null==G?void 0:G.readText)?void 0:_.bind(G),R=null==(E=null==G?void 0:G.write)?void 0:E.bind(G),O=null==(I=null==G?void 0:G.writeText)?void 0:I.bind(G),U=null==(A=C)?void 0:A.ClipboardItem,B=function(){if(!k)throw new Error("No `Promise` implementation available for `clipboard-polyfill`. Consider using: https://github.com/lgarron/clipboard-polyfill#flat-file-version-with-promise-included");return k}(),M=C;function W(){return"undefined"==typeof ClipboardEvent&&void 0!==(null==M?void 0:M.clipboardData)&&void 0!==(null==M?void 0:M.clipboardData.setData)}function P(e,t,r){for(var n in b("listener called"),e.success=!0,t){var o=t[n],i=r.clipboardData;i.setData(n,o),n===m&&i.getData(n)!==o&&(b("setting text/plain failed"),e.success=!1)}r.preventDefault()}function N(e){var t={success:!1},r=P.bind(this,t,e);document.addEventListener("copy",r);try{document.execCommand("copy")}finally{document.removeEventListener("copy",r)}return t.success}function q(e,t){z(e);var r=N(t);return H(),r}function z(e){var t=document.getSelection();if(t){var r=document.createRange();r.selectNodeContents(e),t.removeAllRanges(),t.addRange(r)}}function H(){var e=document.getSelection();e&&e.removeAllRanges()}function Y(e){var t=m in e;if(W()){if(!t)throw new Error("No `text/plain` value was specified.");if(function(e){if(!M.clipboardData)return!1;var t=M.clipboardData.setData("Text",e);return t&&b("writeTextIE worked"),t}(e[m]))return!0;throw new Error("Copying failed, possibly because the user rejected it.")}return N(e)?(b("regular execCopy worked"),!0):navigator.userAgent.indexOf("Edge")>-1?(b('UA "Edge" => assuming success'),!0):q(document.body,e)?(b("copyUsingTempSelection worked"),!0):function(e){var t=document.createElement("div");t.setAttribute("style","-webkit-user-select: text !important"),t.textContent="temporary element",document.body.appendChild(t);var r=q(t,e);return document.body.removeChild(t),r}(e)?(b("copyUsingTempElem worked"),!0):!!function(e){b("copyTextUsingDOM");var t=document.createElement("div");t.setAttribute("style","-webkit-user-select: text !important");var r=t;t.attachShadow&&(b("Using shadow DOM."),r=t.attachShadow({mode:"open"}));var n=document.createElement("span");n.innerText=e,r.appendChild(n),document.body.appendChild(t),z(n);var o=document.execCommand("copy");return H(),document.body.removeChild(t),o}(e[m])&&(b("copyTextUsingDOM worked"),!0)}function F(e,t){for(var r=[],n=0;n<e.length;n++){var o=e[n];r.push(t(o))}return B.all(r).then((t=>{for(var r={},n=0;n<e.length;n++)r[e[n]]=t[n];return r}))}var J=B.resolve(),$=()=>B.resolve(!0),V=B.resolve(!1);function K(e){return new B(((t,r)=>{try{t(e())}catch(e){r(e)}}))}function Q(e){if(!Y(function(e){var t={};return t[m]=e,t}(e)))throw new Error("writeText() failed")}function X(){return K((()=>{if(L)return b("Using `navigator.clipboard.readText()`."),L();if(W()){var e=function(){if(!M.clipboardData)throw new Error("Cannot read IE clipboard Data ");var e=M.clipboardData.getData("Text");if(""===e)throw new Error("Empty clipboard or could not read plain text from clipboard");return e}();return B.resolve(e)}throw new Error("Read is not supported in your browser.")}))}function Z(e,t){for(var r=0;r<e.length;r++){if(-1!==e[r].types.indexOf(t))return!0}return!1}var ee=function(e,t){var r,n=Object.keys(e),o={};for(var i in e){var a=e[i];o[i]="string"==typeof a?te(i,a):a}return{types:n,presentationStyle:null!=(r=null==t?void 0:t.presentationStyle)?r:"unspecified",getType:function(e){return B.resolve(o[e])}}};function te(e,t){return new Blob([t],{type:e})}function re(e){return F(e.types,(function(t){return e.getType(t)})).then((t=>new B(((r,n)=>{var o={};e.presentationStyle&&(o.presentationStyle=e.presentationStyle),U?r(new U(t,o)):n("window.ClipboardItem is not defined")}))))}function ne(e){var t={};return t[m]=te(e,m),new ee(t)}function oe(e,t){return e.getType(t).then((e=>{return t=e,new B(((e,r)=>{var n=new FileReader;n.addEventListener("load",(()=>{var t=n.result;"string"==typeof t?e(t):r("could not convert blob to string")})),n.readAsText(t)}));var t}))}var ie,ae,se=Object.freeze({__proto__:null,ClipboardItem:ee,read:function(){return K((()=>j?(b("Using `navigator.clipboard.read()`."),j()):X().then((e=>[ne(e)]))))},readText:X,setDebugLog:function(e){f=e},suppressWarnings:function(){y=!1},write:function(e){return K((()=>{if(R&&U){var t=R;return b("Using `navigator.clipboard.write()`."),B.all(e.map(re)).then((r=>t(r).then($).catch((t=>{if(!Z(e,m)&&!Z(e,"text/html"))throw t;return V}))))}return V})).then((t=>{if(t)return J;var r=Z(e,m);return y&&!r&&b("clipboard.write() was called without a `text/plain` data type. On some platforms, this may result in an empty clipboard. Call suppressWarnings() to suppress this warning."),function(e){return F(e.types,(function(t){return oe(e,t)}))}(e[0]).then((e=>{if(!Y(e))throw new Error("write() failed")}))}))},writeText:function(e){return K((()=>O?(b("Using `navigator.clipboard.writeText()`."),O(e).catch(Q)):B.resolve(Q(e))))}});class le extends Error{static create(){return new le("The given site selection object is invalid.")}}class ce{constructor(e,t,r){this.site=e,this.language=t,this.group=r}static fromJson(e){const t=JSON.parse(e);if("object"!=typeof t)throw le.create();if(!("site"in t))throw le.create();return new ce(t.site,t.language??null,t.group??null)}getSiteIdentifier(){return this.site}getLanguageId(){return this.language}getGroupName(){return this.group}isWithinGroup(){return null!==this.group}isGroupRoot(){return this.isWithinGroup()&&null===this.language}isGroupItem(){return this.isWithinGroup()&&null!==this.language}}!function(e){e.form=".tx-warming-sites-modal",e.siteCheckbox=".tx-warming-sites-group-selector > input",e.siteCheckboxAll=".tx-warming-sites-group-selector > input[data-select-all]",e.useragentCopy="button.tx-warming-user-agent-copy-action",e.useragentCopyIcon="button.tx-warming-user-agent-copy-action .t3js-icon",e.useragentCopyText=".tx-warming-user-agent-copy-text"}(ie||(ie={})),function(e){e.startButton="tx-warming-start-warmup"}(ae||(ae={}));let ue=class extends s{constructor(){super(),this.cacheWarmer=new o,this.modal=c.currentModal}createRenderRoot(){return this}connectedCallback(){super.connectedCallback(),this.initializeSites()}initializeSites(){const e=this.modal.querySelector(".modal-footer");e.classList.add("tx-warming-modal-footer","visually-hidden"),new t("submit",(e=>(e.preventDefault(),this.performCacheWarmup(),!1))).bindTo(this._form),this._checkboxes.forEach((r=>{new t("input",(t=>{e.classList.remove("visually-hidden"),this.toggleInputs(t.target)})).bindTo(r)})),new t("click",(e=>{e.preventDefault(),e.stopImmediatePropagation();const t=e.currentTarget.dataset.text;t&&this.copyUserAgentToClipboard(t)})).bindTo(this._useragentCopyButton)}performCacheWarmup(){if(!this.areSitesSelected())return void u.warning(TYPO3.lang[i.notificationNoSitesSelectedTitle],TYPO3.lang[i.notificationNoSitesSelectedMessage],15);const{configuration:e,sites:t}=this.parseFormValues();this.cacheWarmer.warmupCache(t,[],e)}parseFormValues(){const e=new FormData(this._form),t={},r={};for(const[n,o]of e)switch(n){case"site":try{const e=ce.fromJson(o.toString()),t=e.getSiteIdentifier();if(e.isGroupRoot())continue;r[t]??(r[t]=[]),r[t].push(e.getLanguageId())}catch(e){}break;case"limit":t.limit=parseInt(o.toString());break;case"strategy":t.strategy=o.toString()}return{configuration:t,sites:r}}toggleInputs(e){if(e.dataset.selectAll)this.toggleAll(e.checked);else{const t=ce.fromJson(e.value);t.isWithinGroup()&&this.toggleGroup(t,e),this.toggleSelectAll(e)}this.areSitesSelected()?this.getStartButton().classList.remove("disabled"):this.getStartButton().classList.add("disabled")}areSitesSelected(){let e=!1;return this._enabledCheckboxesWithoutGroupElements.forEach((t=>{if(t.checked)return e=!0,!1})),e}toggleGroup(e,t){let r=t.checked;null===e.getLanguageId()?this.getCheckboxesByGroup(e.getGroupName()).forEach((e=>{e.checked=r})):(r&&this.getCheckboxesByGroup(e.getGroupName()).forEach((e=>{if(e.id!==t.id&&!e.checked)return r=!1,!1})),this.getCheckboxGroupRoot(e.getGroupName()).checked=r)}toggleAll(e){this._enabledCheckboxes.forEach((t=>{t.checked=e}))}toggleSelectAll(e){let t=e.checked;t&&this._enabledCheckboxesWithoutGroupElements.forEach((r=>{if(r.id!==e.id&&!r.checked)return t=!1,!1})),this._selectAllCheckbox.checked=t}getCheckboxesByGroup(e){return this.renderRoot.querySelectorAll(`input[data-group="${e}"]:enabled`)}getCheckboxGroupRoot(e){return this.renderRoot.querySelector(`input[data-group-root="${e}"]:enabled`)}getStartButton(){return this.modal.querySelector(`button[name=${ae.startButton}]`)}copyUserAgentToClipboard(e){const t=this._useragentCopyIcon.cloneNode(!0);l.getIcon(a.spinner,l.sizes.small).then((e=>{this._useragentCopyIcon.innerHTML=e})),Promise.all([(navigator.clipboard??se).writeText(e),l.getIcon(a.check,l.sizes.small)]).then((async([,e])=>{const r=this._useragentCopyText.innerText;this._useragentCopyText.innerText=TYPO3.lang[i.modalSitesUserAgentActionSuccessful],this._useragentCopyIcon.innerHTML=e,window.setTimeout((()=>{this._useragentCopyIcon.innerHTML=t.innerHTML,this._useragentCopyText.innerText=r,this._useragentCopyButton.blur()}),3e3)}),(()=>{this._useragentCopyIcon.innerHTML=t.innerHTML}))}static createModal(){const e=new URL(TYPO3.settings.ajaxUrls.tx_warming_fetch_sites,window.location.origin);c.dismiss(),c.advanced({type:c.types.ajax,content:e.toString(),title:TYPO3.lang[i.modalSitesTitle],size:c.sizes.medium,buttons:[{text:TYPO3.lang[i.modalSitesButtonStart],icon:a.rocket,btnClass:"btn-primary disabled",name:ae.startButton,trigger:()=>{c.currentModal.querySelector(ie.form).requestSubmit()}}]})}};var de;r([p(ie.form)],ue.prototype,"_form",void 0),r([p(ie.siteCheckboxAll)],ue.prototype,"_selectAllCheckbox",void 0),r([h(ie.siteCheckbox)],ue.prototype,"_checkboxes",void 0),r([h(ie.siteCheckbox+":enabled")],ue.prototype,"_enabledCheckboxes",void 0),r([h(ie.siteCheckbox+":enabled:not([data-select-all])")],ue.prototype,"_enabledCheckboxesWithoutGroupElements",void 0),r([p(ie.useragentCopy)],ue.prototype,"_useragentCopyButton",void 0),r([p(ie.useragentCopyIcon)],ue.prototype,"_useragentCopyIcon",void 0),r([p(ie.useragentCopyText)],ue.prototype,"_useragentCopyText",void 0),ue=r([n("warming-sites-modal")],ue),function(e){e.container="#eliashaeussler-typo3warming-backend-toolbaritems-cachewarmuptoolbaritem"}(de||(de={}));var pe=new class{constructor(){e.ready().then((()=>{new t("click",(()=>{ue.createModal()})).delegateTo(document,de.container)}))}};export{pe as default};
